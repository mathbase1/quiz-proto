<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Prototype Quiz Maker (N7–N9)</title>
<style>
  :root{
    --ink:#0f172a; --muted:#6b7280; --accent:#2563eb; --bg:#ffffff; --border:#e5e7eb;
    --green:#16a34a; --orange:#f59e0b; --red:#dc2626;
    --fbar:1px;
  }

  html,body{
    margin:0;padding:0;background:var(--bg);color:var(--ink);
    font:18px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
  }

  header{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--border)}
  main{max-width:1100px;margin:1.2rem auto 4rem;padding:0 1rem}

  /* top bar */
  .bar{
    display:flex;gap:.65rem;align-items:center;flex-wrap:wrap;
    padding:.75rem .9rem
  }
  .appTitle{font-weight:950;font-size:1.1rem}
  .bar .group{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
  .bar label{font-weight:900;color:#111827;font-size:1rem}
  select, input[type="text"], input[type="number"]{
    padding:.55rem .65rem;border:1px solid var(--border);border-radius:.6rem;min-width:160px;
    background:#fff;color:var(--ink);font-size:1rem
  }
  input[type="text"], input[type="number"]{min-width:180px}
  input::placeholder{font-size:0.85em;}
  .primary{
    background:var(--accent);color:#fff;border:1px solid var(--accent);
    border-radius:.65rem;padding:.6rem 1.05rem;cursor:pointer;font-weight:900;font-size:1rem
  }
  .ghost{
    background:#fff;color:var(--ink);border:1px solid var(--border);
    border-radius:.65rem;padding:.6rem 1.05rem;cursor:pointer;font-weight:900;font-size:1rem
  }
  .danger{
    background:#fff;color:#7f1d1d;border:1px solid rgba(220,38,38,.35);
    border-radius:.65rem;padding:.55rem .9rem;cursor:pointer;font-weight:900;font-size:1rem
  }
  .muted{color:var(--muted);font-size:1rem}
  .spacer{flex:1}
  .actions{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}

  /* panels */
  .panel{
    border:1px solid var(--border);
    border-radius:1rem;
    padding:1rem 1.05rem;
    background:linear-gradient(180deg,#fbfdff,#ffffff);
    box-shadow:0 1px 0 rgba(0,0,0,.03);
    margin-top:1rem;
  }
  .panel h2{margin:.1rem 0 .8rem 0;font-size:1.2rem}
  .panel h3{margin:.1rem 0 .8rem 0;font-size:1.05rem}
  .row{
    display:flex;
    gap:.75rem;
    align-items:flex-end;
    flex-wrap:wrap;
    margin:.4rem 0;
  }
  .row .field{display:flex;flex-direction:column;gap:.25rem}
  .row .field label{font-weight:900;font-size:.95rem;color:#111827}
  .row .field small{color:var(--muted)}
  .divider{height:1px;background:var(--border);margin:1rem 0}

  /* question slot cards */
  .slot{
    border:1px solid var(--border);
    border-radius:1rem;
    overflow:hidden;
    margin-top:1rem;
    box-shadow:0 1px 0 rgba(0,0,0,.03);
  }
  .slotHead{
    padding:.9rem 1.05rem;
    border-bottom:1px solid var(--border);
    background:linear-gradient(180deg,#fbfdff,#f8fafc);
    display:flex;align-items:flex-start;justify-content:space-between;gap:.75rem;flex-wrap:wrap
  }
  .slotHead h3{margin:.1rem 0;font-size:1.1rem}
  .slotControls{display:flex;gap:.6rem;align-items:flex-end;flex-wrap:wrap}
  .slotControls .field{display:flex;flex-direction:column;gap:.25rem}
  .slotControls label{font-weight:900;font-size:.9rem}
  .slotBody{padding:1rem 1.05rem;background:#fff}
  .slotPreview{margin-top:.2rem}

  /* question panel (reused from your generator UI) */
  .qpanel{border:1px solid var(--border);border-radius:1rem;overflow:hidden;margin-top:1rem;
    box-shadow:0 1px 0 rgba(0,0,0,.03)}
  .qhead{
    padding:1rem 1.05rem;border-bottom:1px solid var(--border);
    background:linear-gradient(180deg,#fbfdff,#f8fafc);
    display:flex;align-items:center;justify-content:space-between;gap:.7rem;flex-wrap:wrap
  }
  .qhead h3{margin:.1rem 0;font-size:1.12rem}
  .qbody{padding:1.1rem 1.05rem}
  .qfoot{padding:.85rem 1.05rem;border-top:1px solid var(--border);background:#fff}
  .qscoreline{font-weight:900;color:#0f172a}
  .badge{display:inline-block;margin-left:.55rem;padding:.08rem .5rem;border:1px solid var(--border);
    border-radius:8px;background:#eef2ff;font-size:.95rem}
  .nc-tag{font-weight:900;text-transform:uppercase;letter-spacing:.02em;font-size:.95rem}
  .nc{color:#15803d}
  .calc{color:#1d4ed8}

  .item{padding:.6rem .1rem;border-bottom:1px dashed rgba(229,231,235,.9)}
  .item:last-child{border-bottom:none}
  .line{display:flex;align-items:flex-start;gap:.75rem;flex-wrap:nowrap;}
  .qtext{flex:1;min-width:280px}
  .anscol{display:flex;flex-direction:column;align-items:flex-end;gap:.25rem}
  .endmark{margin-left:.4rem;font-weight:900;color:#334155}

  .unitnote{
    font-weight:900;
    color:#334155;
    font-size:.95rem;
    margin-bottom:.2rem;
  }

  /* inputs - feedback highlighting */
  .ok{outline:2px solid rgba(22,163,74,.35); border-color:rgba(22,163,74,.55)!important}
  .bad{outline:2px solid rgba(220,38,38,.28); border-color:rgba(220,38,38,.55)!important}

  /* fraction widget */
  .frac{display:inline-grid;grid-template-rows:auto 0 auto;row-gap:0;align-items:center;justify-items:center;line-height:0;vertical-align:middle}
  .frac input{
    width:92px;text-align:center;border:1px solid var(--border);border-radius:.45rem;padding:.45rem .5rem;margin:0;
    appearance:textfield;font-size:1rem;min-width:0
  }
  .frac .bar{width:92px;height:0;border-top:var(--fbar) solid #111;margin:16px 0 0 0}
  .frac input:last-child{margin-top:-2px}
  .mini{min-width:150px!important}
  .twobox, .threebox{display:inline-flex;gap:.5rem;align-items:center;flex-wrap:wrap}

  /* tables */
  table.qtable{
    border-collapse:collapse;
    width:100%;
    max-width:540px;
    margin:.55rem 0 .25rem 0;
    font-size:1rem;
  }
  .qtable th, .qtable td{
    border:1px solid var(--border);
    padding:.38rem .6rem;
  }
  .qtable th{background:#f8fafc;font-weight:900;}
  .qtable .num{text-align:right;white-space:nowrap;}

  /* grade boundaries table */
  .gbTable{
    border-collapse:collapse;
    width:100%;
    margin-top:.25rem;
    font-size:1rem;
  }
  .gbTable th, .gbTable td{border:1px solid var(--border);padding:.45rem .6rem}
  .gbTable th{background:#f8fafc;font-weight:900;text-align:left}
  .gbTable td .tinyInput{min-width:120px}
  .gbTable td .pctInput{min-width:110px}
  .gbHelp{color:var(--muted);font-size:.95rem;margin-top:.5rem}
  .answerKey{
    margin-top:.65rem;
    border:1px dashed rgba(107,114,128,.35);
    border-radius:.85rem;
    padding:.6rem .75rem;
    background:#f8fafc;
  }
  .answerKey h4{margin:.1rem 0 .4rem 0;font-size:1rem}
  .answerKey ol{margin:.2rem 0 0 1.1rem}
  .feedback{margin-top:1rem;border:1px solid var(--border);border-radius:.75rem;padding:.85rem 1rem;background:#f8fafc}
  .feedback.good{background:#ecfdf5;border-color:rgba(22,163,74,.22);color:#065f46}
  .feedback.bad{background:#fef2f2;border-color:rgba(220,38,38,.22);color:#7f1d1d}

  /* small screens */
  @media (max-width:720px){
    .line{flex-wrap:wrap}
    .anscol{align-items:flex-start}
    .qtext{min-width:0}
  }
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="group">
      <div class="appTitle">Prototype Quiz Maker</div>
      <div class="muted">Static demo (GitHub Pages friendly) • Bank: N7–N9</div>
    </div>
    <div class="spacer"></div>
    <div class="actions">
      <button class="ghost" id="backToBuilderTopBtn" type="button" style="display:none">Back to builder</button>
      <button class="primary" id="generateQuizTopBtn" type="button">Generate quiz</button>
    </div>
  </div>
</header>

<main>
  <!-- BUILDER VIEW -->
  <section id="builderView">
    <div class="panel">
      <h2>Create quiz</h2>

      <div class="row">
        <div class="field">
          <label for="quizTitle">Quiz title</label>
          <input id="quizTitle" type="text" placeholder="e.g. Spring Diagnostic – Number" />
        </div>

        <div class="field">
          <label for="qCount">Number of questions</label>
          <input id="qCount" type="number" min="1" max="30" value="5" />
          <small class="muted">You can also add/remove questions below.</small>
        </div>

        <div class="actions">
          <button class="ghost" id="setCountBtn" type="button">Set question count</button>
          <button class="ghost" id="addQuestionBtn" type="button">Add question</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div class="muted">
          Each question slot lets you pick a topic (N7/N8/N9), marks (1–5), and paper (calculator/non‑calculator).<br>
          Use “New numbers” to regenerate that slot’s random values.
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>Grade boundaries</h2>
      <div class="muted">These are optional. The quiz result will show a grade if the % score falls within a boundary.</div>

      <table class="gbTable" id="gbTable">
        <thead>
          <tr>
            <th style="width:28%">Grade label</th>
            <th style="width:24%">Min %</th>
            <th style="width:24%">Max %</th>
            <th style="width:24%">Action</th>
          </tr>
        </thead>
        <tbody id="gbBody"></tbody>
      </table>

      <div class="row">
        <button class="ghost" id="addBoundaryBtn" type="button">Add boundary</button>
      </div>

      <div class="gbHelp">
        Example: D = 0–20, C = 21–40, B = 41–60, A = 61–80, A* = 81–100.
      </div>
    </div>

    <div id="slots"></div>
  </section>

  <!-- QUIZ VIEW -->
  <section id="quizView" style="display:none">
    <div class="panel">
      <h2 id="quizTitleHeading">Quiz</h2>
      <div class="muted" id="quizMeta"></div>

      <div class="row" style="margin-top:.8rem">
        <div class="actions">
          <button class="primary" id="submitQuizBtn" type="button">Submit & mark</button>
          <button class="ghost" id="revealAllBtn" type="button">Reveal answers</button>
          <button class="ghost" id="backToBuilderBtn" type="button">Back to builder</button>
        </div>
      </div>

      <div class="feedback" id="quizFeedback" style="display:none"></div>
    </div>

    <div id="quizQuestions"></div>
  </section>
</main>

<script type="module">
  import { BANK_TOPICS, cryptoSeed, generateQuestion, renderQuestionHTML, markQuestion, getAnswerList } from "./questionBank.js";

  // -------------------- State --------------------
  let slots = [];               // builder slots: {topicCode, marksTotal, paperMode, seed}
  let quizQuestions = [];       // instantiated question objects for the quiz view

  // -------------------- DOM --------------------
  const builderView = document.getElementById("builderView");
  const quizView = document.getElementById("quizView");

  const quizTitleInput = document.getElementById("quizTitle");
  const qCountInput = document.getElementById("qCount");
  const setCountBtn = document.getElementById("setCountBtn");
  const addQuestionBtn = document.getElementById("addQuestionBtn");

  const slotsEl = document.getElementById("slots");

  const gbBody = document.getElementById("gbBody");
  const addBoundaryBtn = document.getElementById("addBoundaryBtn");

  const generateQuizTopBtn = document.getElementById("generateQuizTopBtn");
  const backToBuilderTopBtn = document.getElementById("backToBuilderTopBtn");

  const quizTitleHeading = document.getElementById("quizTitleHeading");
  const quizMeta = document.getElementById("quizMeta");
  const quizQuestionsEl = document.getElementById("quizQuestions");

  const submitQuizBtn = document.getElementById("submitQuizBtn");
  const revealAllBtn = document.getElementById("revealAllBtn");
  const backToBuilderBtn = document.getElementById("backToBuilderBtn");
  const quizFeedback = document.getElementById("quizFeedback");

  // -------------------- Grade boundaries --------------------
  function addBoundaryRow({label="", min=0, max=100}={}){
    const tr = document.createElement("tr");
    tr.innerHTML = \`
      <td><input class="tinyInput" type="text" value="\${label}" placeholder="e.g. A" /></td>
      <td><input class="pctInput" type="number" min="0" max="100" step="1" value="\${min}" /></td>
      <td><input class="pctInput" type="number" min="0" max="100" step="1" value="\${max}" /></td>
      <td><button class="danger" type="button">Remove</button></td>
    \`;
    tr.querySelector("button").addEventListener("click", ()=> tr.remove());
    gbBody.appendChild(tr);
  }

  function setDefaultBoundaries(){
    gbBody.innerHTML = "";
    addBoundaryRow({label:"D", min:0, max:20});
    addBoundaryRow({label:"C", min:21, max:40});
    addBoundaryRow({label:"B", min:41, max:60});
    addBoundaryRow({label:"A", min:61, max:80});
    addBoundaryRow({label:"A*", min:81, max:100});
  }

  function readBoundaries(){
    const rows = Array.from(gbBody.querySelectorAll("tr"));
    const out = [];
    for(const r of rows){
      const tds = r.querySelectorAll("td");
      const label = (tds[0].querySelector("input")?.value ?? "").trim();
      const min = Number(tds[1].querySelector("input")?.value);
      const max = Number(tds[2].querySelector("input")?.value);
      if(!label) continue;
      if(!Number.isFinite(min) || !Number.isFinite(max)) continue;
      out.push({label, min, max});
    }
    return out;
  }

  function gradeFromPercent(pct, boundaries){
    const p = Number(pct);
    if(!Number.isFinite(p)) return "";
    // Prefer smallest range that matches, then higher min
    const sorted = boundaries.slice().sort((a,b)=>{
      const ra = Math.abs(a.max-a.min);
      const rb = Math.abs(b.max-b.min);
      if(ra !== rb) return ra - rb;
      return b.min - a.min;
    });
    const hit = sorted.find(b => p >= b.min && p <= b.max);
    return hit ? hit.label : "";
  }

  // -------------------- Slot management --------------------
  function makeDefaultSlot(){
    return {
      topicCode: "N7",
      marksTotal: 1,
      paperMode: "noncalc",
      seed: cryptoSeed()
    };
  }

  function setQuestionCount(n){
    const target = Math.max(1, Math.min(30, Number(n)||1));
    if(slots.length < target){
      while(slots.length < target) slots.push(makeDefaultSlot());
    }else if(slots.length > target){
      slots = slots.slice(0, target);
    }
    qCountInput.value = target;
    renderSlots();
  }

  function removeSlot(idx){
    slots.splice(idx, 1);
    if(slots.length === 0) slots.push(makeDefaultSlot());
    qCountInput.value = slots.length;
    renderSlots();
  }

  // -------------------- Rendering slots --------------------
  function topicOptionsHtml(selected){
    return BANK_TOPICS.map(t=>{
      const sel = (t.code === selected) ? "selected" : "";
      return \`<option value="\${t.code}" \${sel}>\${t.code} — \${t.name}</option>\`;
    }).join("");
  }

  function renderSlots(){
    slotsEl.innerHTML = "";

    slots.forEach((slot, idx)=>{
      const card = document.createElement("div");
      card.className = "slot";
      card.dataset.slotIndex = String(idx);

      card.innerHTML = \`
        <div class="slotHead">
          <h3>Question \${idx+1}</h3>

          <div class="slotControls">
            <div class="field">
              <label>Topic</label>
              <select data-field="topic">\${topicOptionsHtml(slot.topicCode)}</select>
            </div>

            <div class="field">
              <label>Marks</label>
              <select data-field="marks">
                \${[1,2,3,4,5].map(m=>\`<option value="\${m}" \${Number(slot.marksTotal)===m?"selected":""}>\${m}</option>\`).join("")}
              </select>
            </div>

            <div class="field">
              <label>Paper</label>
              <select data-field="paper">
                <option value="noncalc" \${slot.paperMode==="noncalc"?"selected":""}>Non‑calculator</option>
                <option value="calc" \${slot.paperMode==="calc"?"selected":""}>Calculator</option>
              </select>
            </div>

            <div class="actions">
              <button class="ghost" data-action="preview" type="button">Preview</button>
              <button class="ghost" data-action="regen" type="button">New numbers</button>
              <button class="danger" data-action="remove" type="button">Remove</button>
            </div>
          </div>
        </div>

        <div class="slotBody">
          <div class="slotPreview" data-preview></div>
        </div>
      \`;

      // wire controls
      const topicSel = card.querySelector('select[data-field="topic"]');
      const marksSel = card.querySelector('select[data-field="marks"]');
      const paperSel = card.querySelector('select[data-field="paper"]');

      const previewBtn = card.querySelector('button[data-action="preview"]');
      const regenBtn = card.querySelector('button[data-action="regen"]');
      const removeBtn = card.querySelector('button[data-action="remove"]');

      const previewEl = card.querySelector("[data-preview]");

      const rerenderPreview = ()=>{
        const q = generateQuestion({
          topicCode: slot.topicCode,
          marksTotal: slot.marksTotal,
          paperMode: slot.paperMode,
          seed: slot.seed,
          instanceId: \`preview_\${idx}\`
        });
        previewEl.innerHTML = renderQuestionHTML(q, {questionNumber: idx+1});
      };

      topicSel.addEventListener("change", ()=>{
        slot.topicCode = topicSel.value;
        rerenderPreview();
      });
      marksSel.addEventListener("change", ()=>{
        slot.marksTotal = Number(marksSel.value);
        rerenderPreview();
      });
      paperSel.addEventListener("change", ()=>{
        slot.paperMode = paperSel.value;
        rerenderPreview();
      });

      previewBtn.addEventListener("click", rerenderPreview);
      regenBtn.addEventListener("click", ()=>{
        slot.seed = cryptoSeed();
        rerenderPreview();
      });
      removeBtn.addEventListener("click", ()=> removeSlot(idx));

      // auto-preview initially
      rerenderPreview();

      slotsEl.appendChild(card);
    });
  }

  // -------------------- Quiz generation --------------------
  function generateQuiz(){
    const title = (quizTitleInput.value || "").trim() || "Quiz";
    const boundaries = readBoundaries();

    quizQuestions = slots.map((slot, idx)=> generateQuestion({
      topicCode: slot.topicCode,
      marksTotal: slot.marksTotal,
      paperMode: slot.paperMode,
      seed: slot.seed,
      instanceId: \`quiz_\${idx}\`
    }));

    const totalMarks = quizQuestions.reduce((s,q)=> s + (q.marksTotal||0), 0);

    quizTitleHeading.textContent = title;
    quizMeta.textContent = \`\${quizQuestions.length} question(s) • Total: \${totalMarks} mark(s)\`;

    quizQuestionsEl.innerHTML = quizQuestions.map((q, i)=> renderQuestionHTML(q, {questionNumber:i+1})).join("");

    // reset feedback
    quizFeedback.style.display = "none";
    quizFeedback.className = "feedback";
    quizFeedback.innerHTML = "";

    // swap views
    builderView.style.display = "none";
    quizView.style.display = "block";
    backToBuilderTopBtn.style.display = "inline-block";
    generateQuizTopBtn.style.display = "none";

    // attach boundaries to quiz view state
    quizView.dataset.boundaries = JSON.stringify(boundaries);
  }

  function backToBuilder(){
    quizView.style.display = "none";
    builderView.style.display = "block";
    backToBuilderTopBtn.style.display = "none";
    generateQuizTopBtn.style.display = "inline-block";
    window.scrollTo({top:0, behavior:"smooth"});
  }

  // -------------------- Marking --------------------
  function submitAndMark(){
    const boundaries = JSON.parse(quizView.dataset.boundaries || "[]");

    let score = 0;
    let max = 0;

    const panels = Array.from(quizQuestionsEl.querySelectorAll(".qpanel"));
    panels.forEach((panel, idx)=>{
      const q = quizQuestions[idx];
      const r = markQuestion(panel, q);
      score += r.score;
      max += r.max;
    });

    const pct = (max>0) ? (score / max * 100) : 0;
    const grade = gradeFromPercent(pct, boundaries);

    quizFeedback.style.display = "block";
    quizFeedback.className = "feedback " + (pct>=80 ? "good" : (pct===0 ? "bad" : ""));
    quizFeedback.innerHTML = \`
      <div style="font-weight:950;font-size:1.05rem">Result</div>
      <div style="margin-top:.35rem"><b>Total:</b> \${score} / \${max} (\${pct.toFixed(1)}%) \${grade ? \`• <b>Grade:</b> \${grade}\` : ""}</div>
    \`;
  }

  function revealAllAnswers(){
    const panels = Array.from(quizQuestionsEl.querySelectorAll(".qpanel"));
    panels.forEach((panel, idx)=>{
      const q = quizQuestions[idx];
      const existing = panel.querySelector("[data-answerkey]");
      if(existing) existing.remove();

      const answers = getAnswerList(q);
      const box = document.createElement("div");
      box.className = "answerKey";
      box.dataset.answerkey = "1";
      box.innerHTML = \`
        <h4>Answer key</h4>
        <ol>\${answers.map(a=>\`<li>\${a}</li>\`).join("")}</ol>
      \`;
      panel.appendChild(box);
    });
  }

  // -------------------- Events --------------------
  setCountBtn.addEventListener("click", ()=> setQuestionCount(qCountInput.value));
  addQuestionBtn.addEventListener("click", ()=>{
    slots.push(makeDefaultSlot());
    qCountInput.value = slots.length;
    renderSlots();
  });

  addBoundaryBtn.addEventListener("click", ()=> addBoundaryRow({label:"", min:0, max:0}));

  generateQuizTopBtn.addEventListener("click", generateQuiz);
  backToBuilderTopBtn.addEventListener("click", backToBuilder);

  submitQuizBtn.addEventListener("click", submitAndMark);
  revealAllBtn.addEventListener("click", revealAllAnswers);
  backToBuilderBtn.addEventListener("click", backToBuilder);

  // -------------------- Init --------------------
  setDefaultBoundaries();
  setQuestionCount(5);
</script>
</body>
</html>
